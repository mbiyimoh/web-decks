# Shareable Artifact Links with Client-Controlled Password Protection

**Slug:** shareable-artifact-links
**Author:** Claude Code
**Date:** 2026-01-23
**Branch:** feature/shareable-artifact-links
**Related:** Existing ValidationLink system in Clarity Canvas

---

## 1) Intent & Assumptions

**Task brief:** Enable portal clients (e.g., Tradeblock) to share specific artifacts (decks, proposals, documents) with external parties via a dedicated shareable link. The client sets a simple password when generating the link, and recipients access the content by entering that password—without needing full portal access. This functionality should be available in all portals but toggled on/off for different artifacts manually via code.

**Assumptions:**
- This is a client-facing feature (e.g., Tradeblock sharing investor decks with their investors)
- Password is set per-shareable-link by the client when they click "Share"
- Shareable links are separate from portal authentication (simpler, lighter-weight)
- Initial implementation is code-toggled via `ContentItem` configuration (no admin UI)
- Links can be invalidated/regenerated by 33 Strategies via code
- Multiple links can exist for the same artifact with different passwords
- Session lasts 24 hours after password entry (no re-entry per page view)

**Out of scope:**
- Admin UI for managing shareable links (v1 is code-toggled)
- Analytics/tracking dashboard for who accessed shared links
- Automatic expiration dates on links (could be added later)
- Rate limiting infrastructure (Redis, Upstash) - use simple per-link lockout only
- CAPTCHA integration
- Email notification when links are accessed

---

## 2) Pre-reading Log

- `lib/clients.ts`: ContentItem interface defines artifact structure. Key insight: artifacts are configuration-driven, not database-stored. Need to add `shareable?: boolean` flag.
- `lib/session.ts`: iron-session configuration already in place. Can extend for share-link sessions with separate cookie name/path.
- `app/api/client-auth/route.ts`: Uses `secureCompare()` for timing-safe password comparison. Pattern to follow.
- `app/client-portals/[client]/[slug]/page.tsx`: Renders artifact components. Will need parallel route for shared access.
- `components/portal/EnhancedPortal.tsx`: Shows artifact tiles. Need to add "Share" button for shareable artifacts.
- `prisma/schema.prisma`: ValidationLink model exists with slug, sessions. Can adapt pattern for ArtifactShareLink.
- `lib/clarity-canvas/modules/persona-sharpener/validation-utils.ts`: Has `generateValidationSlug()` using 16-char hex. Research suggests nanoid(21) is better.
- `app/validate/[slug]/route.ts`: Public validation access pattern - always shows password prompt, validates on POST.

---

## 3) Codebase Map

**Primary components/modules:**
- `lib/clients.ts` - ContentItem interface, needs `shareable` flag
- `app/client-portals/[client]/[slug]/page.tsx` - Current protected artifact rendering
- `app/share/[slug]/page.tsx` (new) - Public share link password entry + artifact rendering
- `app/api/share/[slug]/auth/route.ts` (new) - Password verification endpoint
- `components/portal/EnhancedPortal.tsx` - Add share button to artifact tiles
- `components/portal/ShareLinkModal.tsx` (new) - Share link creation modal

**Shared dependencies:**
- `iron-session` - Session management (extend with share-link session type)
- `bcrypt` - Password hashing (need to add dependency)
- `nanoid` - Slug generation (need to add dependency)
- `lib/prisma.ts` - Database client
- `lib/auth-utils.ts` - secureCompare function

**Data flow:**
1. Client clicks "Share" on artifact in portal → ShareLinkModal opens
2. Client sets password → POST `/api/share/create` → Creates ArtifactShareLink in DB with bcrypt hash
3. Client copies link + shares password separately
4. External user visits `/share/[slug]` → Shows password prompt
5. External user enters password → POST `/api/share/[slug]/auth` → Verifies bcrypt, sets iron-session cookie
6. Cookie valid → Renders artifact component
7. Cookie invalid/expired → Back to password prompt

**Feature flags/config:**
- `ContentItem.shareable: boolean` - Enable/disable per-artifact in `lib/clients.ts`
- No runtime feature flags needed for v1

**Potential blast radius:**
- New database model (ArtifactShareLink)
- New routes (/share/[slug], /api/share/*)
- Extends EnhancedPortal with share button
- Adds bcrypt, nanoid dependencies
- Does NOT affect existing portal auth or validation system

---

## 4) Root Cause Analysis

N/A - This is a new feature, not a bug fix.

---

## 5) Research

### Potential Solutions

#### Option A: Database-Stored Share Links (Recommended)

**Approach:** Create `ArtifactShareLink` model in Prisma with slug, bcrypt-hashed password, clientId, artifactSlug, and metadata. Use iron-session for authenticated sessions.

**Pros:**
- Consistent with existing ValidationLink pattern
- Full control over link lifecycle (create, invalidate, track access)
- Supports multiple links per artifact with different passwords
- Easy to add expiration, access counts later
- Secure: bcrypt hashing, rate limiting via failedAttempts

**Cons:**
- Requires database migration
- Slightly more complex than signed tokens
- Need to manage link cleanup/expiration manually

**Implementation complexity:** Medium

#### Option B: Signed JWT Tokens (Passwordless)

**Approach:** Generate signed JWT containing artifactSlug, clientId, and expiration. URL contains the token itself (`/share?token=xxx`). No password needed - having the token = access.

**Pros:**
- No database storage needed
- Simpler implementation
- Built-in expiration
- Cannot be brute-forced (cryptographically signed)

**Cons:**
- Cannot be revoked without rotating signing key
- Less intuitive UX (no password, just long URL)
- Doesn't match user request (they want client-set passwords)
- Token in URL can leak via referrer headers

**Implementation complexity:** Low

#### Option C: Hybrid (Database Link + Optional Password)

**Approach:** Database-stored links that can be either password-protected or passwordless (signed token fallback). Client chooses security level.

**Pros:**
- Maximum flexibility
- Supports both use cases
- Future-proof

**Cons:**
- Most complex to implement
- Unclear UX (too many options)
- Over-engineered for v1 requirements

**Implementation complexity:** High

### Recommendation

**Option A: Database-Stored Share Links** is the recommended approach because:

1. **Matches user requirements**: Client explicitly wants to set a password they control
2. **Consistent with codebase**: Follows existing ValidationLink pattern
3. **Secure by default**: bcrypt hashing, per-link lockout, timing-safe comparison
4. **Extensible**: Easy to add expiration, analytics, revocation later
5. **Good UX**: Familiar "enter password to access" flow (like Figma, Dropbox)

### Technical Recommendations from Research

| Aspect | Recommendation |
|--------|----------------|
| **Password hashing** | bcrypt with work factor 10 |
| **Slug generation** | nanoid(21) - 126 bits entropy, URL-friendly |
| **Session storage** | iron-session HttpOnly cookie scoped to `/share/[slug]` |
| **Brute force protection** | Per-link lockout after 5 attempts for 15 minutes |
| **Enumeration prevention** | Always show password prompt, same 401 response for all failures |

---

## 6) Clarification

1. **Password requirements**: Should there be minimum password length/complexity requirements, or accept any password the client sets?
   - Recommendation: Minimum 6 characters, no complexity requirements (client sets it, not end users)

2. **Multiple links per artifact**: Can a client create multiple share links for the same artifact (e.g., different passwords for different investor groups)?
   - Recommendation: Yes, allow multiple links per artifact

3. **Link invalidation**: How should link invalidation work?
   - Option A: 33 Strategies invalidates via code/database
   - Option B: Client can invalidate from portal UI
   - Recommendation: v1 = Option A (code), v2 = add client UI

4. **Session duration**: How long should access last after entering correct password?
   - Recommendation: 24 hours sliding window (refreshes on each page view)

5. **Share button visibility**: Should the "Share" button appear in the portal even for non-shareable artifacts (disabled state)?
   - Option A: Only show for shareable artifacts
   - Option B: Show for all, but disabled/tooltip for non-shareable
   - Recommendation: Option A (cleaner, less confusing)

6. **Password display after creation**: Should the modal show the password after link creation so client can copy it?
   - Recommendation: Yes, show password + link in confirmation state with "copy" buttons and security warning to share via separate channels

7. **Branding on share page**: Should the share link password page show:
   - Option A: 33 Strategies branding only
   - Option B: Client branding (Tradeblock logo)
   - Option C: Both
   - Recommendation: Option C (33 Strategies as platform, artifact title shows client context)

---

## Proposed Schema

```prisma
model ArtifactShareLink {
  id             String    @id @default(cuid())
  slug           String    @unique  // nanoid(21)

  // What's being shared
  clientId       String    // e.g., "tradeblock"
  artifactSlug   String    // e.g., "jan-2026-projections"

  // Security
  hashedPassword String    // bcrypt hash
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?

  // Metadata
  createdAt      DateTime  @default(now())
  createdBy      String?   // User ID who created (optional for v1)
  lastAccessedAt DateTime?
  accessCount    Int       @default(0)

  // Future: expiration, max uses
  // expiresAt    DateTime?
  // maxUses      Int?

  @@index([slug])
  @@index([clientId, artifactSlug])
}
```

## Proposed ContentItem Extension

```typescript
interface ContentItem {
  slug: string;
  type: 'deck' | 'proposal' | 'document';
  title: string;
  description?: string;
  addedOn?: string;
  lastUpdated?: string;
  tagOverride?: string;
  component: ComponentType;
  shareable?: boolean;  // NEW: Enable share link functionality
}
```

## Proposed Route Structure

```
app/
├── share/
│   └── [slug]/
│       ├── page.tsx           # Password entry → artifact render
│       └── opengraph-image.tsx # OG image for share links
├── api/
│   └── share/
│       ├── create/
│       │   └── route.ts       # POST: Create share link (portal-authenticated)
│       └── [slug]/
│           └── auth/
│               └── route.ts   # POST: Verify password, set session
```

---

## Next Steps

1. Get user clarification on questions above
2. Create specification document with detailed implementation plan
3. Add bcrypt and nanoid dependencies
4. Create database migration for ArtifactShareLink
5. Implement API routes
6. Implement share page UI
7. Add share button to portal
8. Test end-to-end flow
9. Deploy and verify

---

*This ideation document captures the discovery and research phase. Proceed to specification once clarifications are resolved.*
